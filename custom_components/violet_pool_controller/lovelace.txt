# Erweiterte Lovelace-Karten mit Parameter-Eingabe

type: vertical-stack
cards:
  # PUMPEN-STEUERUNG MIT PARAMETERN
  - type: custom:fold-entity-row
    head:
      type: section
      label: "üîÑ Pumpen-Steuerung"
    entities:
      - type: horizontal-stack
        cards:
          # Geschwindigkeits-Auswahl
          - type: entities
            entities:
              - entity: input_select.pump_speed
                name: Geschwindigkeit
              - entity: input_number.pump_duration
                name: Laufzeit (Sek.)
            
          # Pumpen-Aktionen
          - type: custom:button-card
            entity: switch.violet_pool_controller_pump
            name: Pumpe Starten
            icon: mdi:play
            tap_action:
              action: call-service
              service: script.start_pump_with_params
            styles:
              card:
                - height: 60px
                - background-color: |
                    [[[
                      if (entity.attributes.mode === 'auto') return 'rgba(76, 175, 80, 0.1)';
                      if (entity.attributes.mode === 'manual_on') return 'rgba(255, 152, 0, 0.1)';
                      return 'rgba(244, 67, 54, 0.1)';
                    ]]]
            
          - type: custom:button-card
            name: AUTO
            icon: mdi:auto-mode
            tap_action:
              action: call-service
              service: violet_pool_controller.set_auto_mode
              service_data:
                entity_id: switch.violet_pool_controller_pump
            styles:
              card:
                - height: 60px
                - background-color: rgba(76, 175, 80, 0.1)

  # DOSIERUNGS-STEUERUNG MIT PARAMETERN  
  - type: custom:fold-entity-row
    head:
      type: section
      label: "üíä Dosierungs-Steuerung"
    entities:
      - type: horizontal-stack
        cards:
          # Parameter-Eingabe
          - type: entities
            entities:
              - entity: input_select.dosing_type
                name: Dosierungstyp
              - entity: input_number.dosing_duration
                name: Dauer (Sek.)
              - entity: input_boolean.dosing_safety_override
                name: Sicherheit √ºberschreiben
            
          # Dosierungs-Aktionen
          - type: vertical-stack
            cards:
              - type: custom:button-card
                name: Dosierung starten
                icon: mdi:flask-plus
                tap_action:
                  action: call-service
                  service: script.dose_with_params
                styles:
                  card:
                    - height: 50px
                    - background-color: rgba(255, 152, 0, 0.1)
                    
              - type: custom:button-card
                name: Alle AUTO
                icon: mdi:auto-mode
                tap_action:
                  action: call-service
                  service: violet_pool_controller.set_auto_mode
                  service_data:
                    entity_id:
                      - switch.violet_pool_controller_dos_1_cl
                      - switch.violet_pool_controller_dos_4_phm
                      - switch.violet_pool_controller_dos_5_php

  # ERWEITERTE FUNKTIONEN
  - type: custom:fold-entity-row
    head:
      type: section
      label: "‚öôÔ∏è Erweiterte Funktionen"
    entities:
      - type: horizontal-stack
        cards:
          # R√ºcksp√ºlung mit Timer
          - type: entities
            title: R√ºcksp√ºlung
            entities:
              - entity: input_number.backwash_duration
                name: Dauer (Sek.)
              - type: custom:button-card
                entity: switch.violet_pool_controller_backwash
                name: R√ºcksp√ºlung
                icon: mdi:valve-open
                tap_action:
                  action: call-service
                  service: script.backwash_with_params
                hold_action:
                  action: call-service
                  service: switch.turn_off
                  service_data:
                    entity_id: switch.violet_pool_controller_backwash
                    
          # Erweiterungsrelais mit Timer
          - type: entities
            title: Relais-Timer
            entities:
              - entity: input_number.extension_timer
                name: Laufzeit (Sek.)
              - type: custom:button-card
                name: EXT1-3 Timer
                icon: mdi:timer-play
                tap_action:
                  action: call-service
                  service: violet_pool_controller.set_extension_timer
                  service_data:
                    entity_id: switch.violet_pool_controller_ext1_3
                    duration: "{{ states('input_number.extension_timer') | int }}"

  # QUICK-ACTIONS MIT VORDEFINIERTEN WERTEN
  - type: horizontal-stack
    cards:
      # Schnelle Pumpen-Modi
      - type: custom:button-card
        name: "Eco 2h"
        icon: mdi:leaf
        tap_action:
          action: call-service
          service: violet_pool_controller.set_pump_speed
          service_data:
            entity_id: switch.violet_pool_controller_pump
            speed: 1
            duration: 7200
        styles:
          card:
            - height: 50px
            - font-size: 12px

      - type: custom:button-card
        name: "Normal 4h"
        icon: mdi:play
        tap_action:
          action: call-service
          service: violet_pool_controller.set_pump_speed
          service_data:
            entity_id: switch.violet_pool_controller_pump
            speed: 2
            duration: 14400
        styles:
          card:
            - height: 50px
            - font-size: 12px

      - type: custom:button-card
        name: "Boost 1h"
        icon: mdi:fast-forward
        tap_action:
          action: call-service
          service: violet_pool_controller.set_pump_speed
          service_data:
            entity_id: switch.violet_pool_controller_pump
            speed: 3
            duration: 3600
        styles:
          card:
            - height: 50px
            - font-size: 12px

      - type: custom:button-card
        name: "Pause 10m"
        icon: mdi:pause
        tap_action:
          action: call-service
          service: violet_pool_controller.force_off
          service_data:
            entity_id: switch.violet_pool_controller_pump
            lock_duration: 600
        styles:
          card:
            - height: 50px
            - font-size: 12px

  # DOSIERUNGS QUICK-ACTIONS
  - type: horizontal-stack
    cards:
      - type: custom:button-card
        name: "Chlor 30s"
        icon: mdi:flask
        tap_action:
          action: call-service
          service: violet_pool_controller.manual_dosing
          service_data:
            entity_id: switch.violet_pool_controller_dos_1_cl
            duration: 30
        styles:
          card:
            - height: 50px
            - font-size: 12px

      - type: custom:button-card
        name: "pH- 30s"
        icon: mdi:flask-minus
        tap_action:
          action: call-service
          service: violet_pool_controller.manual_dosing
          service_data:
            entity_id: switch.violet_pool_controller_dos_4_phm
            duration: 30
        styles:
          card:
            - height: 50px
            - font-size: 12px

      - type: custom:button-card
        name: "pH+ 30s"
        icon: mdi:flask-plus
        tap_action:
          action: call-service
          service: violet_pool_controller.manual_dosing
          service_data:
            entity_id: switch.violet_pool_controller_dos_5_php
            duration: 30
        styles:
          card:
            - height: 50px
            - font-size: 12px

      - type: custom:button-card
        name: "Schock 2min"
        icon: mdi:flask-plus-outline
        tap_action:
          action: call-service
          service: violet_pool_controller.manual_dosing
          service_data:
            entity_id: switch.violet_pool_controller_dos_1_cl
            duration: 120
        styles:
          card:
            - height: 50px
            - font-size: 12px
            - color: red

  # STATUS-ANZEIGE MIT PARAMETERN
  - type: entities
    title: "üìä Aktuelle Parameter"
    show_header_toggle: false
    entities:
      - type: custom:template-entity-row
        entity: switch.violet_pool_controller_pump
        name: Filterpumpe
        secondary: |
          Modus: {{ state_attr('switch.violet_pool_controller_pump', 'mode') | title }}
          {% if state_attr('switch.violet_pool_controller_pump', 'pump_rpm') %}
          | RPM: {{ state_attr('switch.violet_pool_controller_pump', 'pump_rpm') }}
          {% endif %}
          {% if state_attr('switch.violet_pool_controller_pump', 'remaining_time') %}
          | Verbleibend: {{ state_attr('switch.violet_pool_controller_pump', 'remaining_time') }}
          {% endif %}

      - type: custom:template-entity-row
        entity: switch.violet_pool_controller_dos_1_cl
        name: Chlor-Dosierung
        secondary: |
          {% set runtime = state_attr('switch.violet_pool_controller_dos_1_cl', 'runtime') %}
          {% if runtime and runtime != '00:00:00' %}
          Aktiv: {{ runtime }}
          {% else %}
          Modus: {{ state_attr('switch.violet_pool_controller_dos_1_cl', 'mode') | title }}
          {% endif %}
          {% if state_attr('switch.violet_pool_controller_dos_1_cl', 'remaining_range') %}
          | Vorrat: {{ state_attr('switch.violet_pool_controller_dos_1_cl', 'remaining_range') }}
          {% endif %}