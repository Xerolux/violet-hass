{
  "permissions": {
    "allow": [
      "Bash(python -m py_compile:*)",
      "Bash(pip install:*)",
      "Bash(pytest:*)",
      "Bash(python -m pytest:*)",
      "Bash(python:*)",
      "Bash(curl:*)",
      "Bash(cat:*)",
      "Bash(python3:*)",
      "Bash(git add:*)",
      "Bash(PUMP_ANTI_FREEZE\")\n\n## HIGH Priority Fixes (9)\n\n### Exception Handling & Initialization\n- **climate.py**: Add InvalidStateError to exception handler\n  - task.exception() can raise InvalidStateError\n  - Extended catch to handle both CancelledError and InvalidStateError\n\n- **device.py**: Initialize _fw_logged in __init__\n  - Previously created dynamically with hasattr check\n  - Now properly initialized as instance variable\n\n### Data Validation & Type Safety\n- **switch.py**: Correct speed validation range to 0-3\n  - Was: 1-4 (incorrect based on live data)\n  - Now: 0-3 (matches PUMP_RPM_0 to PUMP_RPM_3)\n  - Verified with live controller data\n\n- **const_features.py**: Add missing \"flocculation\" feature\n  - Feature ID referenced but not defined in AVAILABLE_FEATURES\n  - Added: {\"id\": \"flocculation\", \"name\": \"Flockungsmittel-Dosierung\"}\n\n- **const_features.py**: Fix NumberDeviceClass.VOLUME usage\n  - VOLUME device class doesn''''t exist in Home Assistant\n  - Changed to None with explanatory comment (4 occurrences)\n\n### Precision & Code Quality\n- **number.py**: Preserve float precision for ORP values\n  - Was: int(sanitized_value) - lost decimal precision\n  - Now: sanitized_value - preserves 650.5 instead of 650\n\n- **services.py**: Eliminate duplicate function\n  - _normalize_device_ids now calls _as_device_id_list\n  - Removed code duplication between lines 45 and 315\n\n- **services.py**: Add input validation to extract_device_key\n  - Added checks for empty/invalid entity_ids\n  - Validates domain separator presence\n  - Raises ValueError with descriptive messages\n\n## MEDIUM Optimizations (4)\n\n### Performance Improvements\n- **utils_sanitizer.py**: Fix HTML escape redundancy\n  - HTML escape now only applied when special chars allowed\n  - Prevents escaping after chars already removed\n\n- **utils_rate_limiter.py**: Improve token refill logic\n  - Was: Only refilled when time_passed >= time_window\n  - Now: Proportional refill on every call (time_passed > 0)\n  - More accurate rate limiting\n\n### Documentation Updates\n- **CLAUDE.md**: Update pump speed range (1-3 â†’ 0-3)\n- **CLAUDE.md**: Document all states 0-6 with descriptions\n- **CLAUDE.md**: Clarify state handling and composite states\n\n## Live Testing\n\nVerified against real controller (192.168.178.55, FW 1.1.8):\nâœ“ PUMP: 3 (AUTO - Active)\nâœ“ HEATER: 2 (AUTO - Active)  \nâœ“ SOLAR: 1 (MANUAL ON)\nâœ“ COVER_STATE: \"OPEN\" (string handling verified)\nâœ“ REFILL: 5 (State 5 verified)\nâœ“ PUMP_RPM_0-3: Speed range 0-3 confirmed\nâœ“ DOS_1_CL_STATE: Array handling observed\n\n## Impact Summary\n\n- **18 bugs fixed** (5 CRITICAL, 9 HIGH, 4 MEDIUM)\n- **10 files changed** in custom_components/violet_pool_controller/\n- **Production stability** improved (no silent assertion failures)\n- **Data integrity** enhanced (float precision, validation)\n- **Performance** optimized (HTML escape, token refill)\n- **Code quality** improved (deduplication, documentation)\n\nSee BUGFIX_SUMMARY.md for detailed analysis.\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git commit:*)",
      "Bash(PUMP_ANTI_FREEZE\" â†’ displays \"Pump Anti Freeze\"\n- Added extra_state_attributes:\n  - numeric_state: The numeric state (0-6)\n  - detail_code: Raw detail code (e.g., \"PUMP_ANTI_FREEZE\")\n  - detail_readable: Human-readable detail\n  - raw_value: Original pipe-separated value\n- Integrated composite sensors into _create_special_sensors function\n- Reuses VioletDosingStateSensor class for both array and pipe-separated values\n\n## Live Testing Results\n\nTested against controller 192.168.178.55 (FW 1.1.8):\n\n### API Read Tests âœ…\n- PUMP: 3 (AUTO - Active)\n- PUMPSTATE: \"3)",
      "Bash(PUMP_ANTI_FREEZE\" â†’ parsed correctly\n- HEATER: 2 (AUTO - Active)\n- HEATERSTATE: \"2)",
      "Bash(BLOCKED_BY_OUTSIDE_TEMP\" â†’ parsed correctly\n- SOLAR: 1 (MANUAL ON)\n- SOLARSTATE: \"0)"
    ],
    "deny": [],
    "ask": []
  }
}
